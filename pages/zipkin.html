Zipkin — SBAB Docs  documentation SBAB Docs Ansible Controller Ansible Roles Ansible Vault Argo Workflows Authentication & Authorization Bitbucket Boost Chatbot Booli Ceph Dex Fortigate troubleshooting Generate certificate Go GitHub Copilot GitLab @Sbab User Guide GitLab Maintenance Grafana Istio Java Jenkins Jenkinsfile Jmeter Kafka Maintenance Kafka @Sbab User Guide Kafka Connect Kubectl Access Kubernetes Lab environment Local Open Web Metrics infrastructure MongoDB Netbox NVIDIA Neo4J Sonatype Nexus repository Oracle OWASP Database OWASP @Sbab User Guide Pact Principles of Security Prometheus ReactJS Redis Renovate S3 Security Guidelines for Developers Sentry Maintenance Sentry User Guide Configuring Variables for Services Deployed to Kubernetes Software Architecture SonarQube Maintenance SonarQube User Guide Structurizr System Landscape Vagrant Zipkin URLâs Configuration Spring Boot 3 Usage - RestTemplate Usage - Retrofit library Dropwizard Usage - Application class Usage - Configuration class Zipkin server Deploy Update Zipkin service update Elasticsearch update Trouble shooting Windows Pipelines SBAB Docs » Zipkin View page source Zipkin ï Tip For more information, see the official Zipkin documentation . URLâs ï Note There are upstream issues with Zipkin, causing white pages in the browser. The temporary solution is to either do a hard refresh or
open Inspect Elements. For more information, see: https://github.com/openzipkin/zipkin/issues/1911 https://github.com/openzipkin/zipkin/issues/2175 Sys: http://zipkin.sys.sbab.se Acc: http://zipkin.acc.sbab.se Stage: http://zipkin.stage.sbab.se Prod: http://zipkin.common.sbab.se Configuration ï Traces are sent to the Zipkin server over Kafka using the topic zipkin , which the Zipkin server then consumes. Spring Boot 3 ï Use the common-tracing-spring-boot-starter library for
Spring Boot 3 to automatically configure tracing for Zipkin. Follow the documentation in the README.md file. Note See the Kafka kafka-spring-boot to find all the remaining properties: . For more information, see the spring-template repository,
which has Zipkin configured. Usage - RestTemplate ï A default RestTemplate bean is automatically created by the common-tracing-spring-boot-starter library that will
pass relevant headers to downstream services. You should not bypass the Spring injection framework when creating a RestTemplate. Does not work private final RestTemplate restTemplate ; public IndexController () { restTemplate = new RestTemplate (); } Usage - Retrofit library ï When the retrofit library is used more manual setup are needed to make sure the zipkin information is sent downstream. private interface InterestAPI { @GET ( "api/v1/interest" ) Call < Object > getListInterests (); } public String retrofit () throws IOException { final Tracing tracing = Tracing . newBuilder () . localServiceName ( "http://swarmworker11.sys.sbab.se:9411/" ) . currentTraceContext ( ThreadLocalCurrentTraceContext . newBuilder () . addScopeDecorator ( ThreadContextScopeDecorator . create ()) // puts trace IDs into logs . build () ) . build (); final HttpTracing httpTracing = HttpTracing . create ( tracing ); OkHttpClient okHttp = new OkHttpClient . Builder () . dispatcher ( new Dispatcher ( httpTracing . tracing (). currentTraceContext (). executorService ( new Dispatcher (). executorService ()))) . addNetworkInterceptor ( TracingInterceptor . create ( httpTracing )) . build (); Retrofit retrofit = new Retrofit . Builder () . baseUrl ( "http://localhost:8091/interest-service/" ) . addConverterFactory ( JacksonConverterFactory . create ()) . client ( okHttp ) . build (); InterestAPI interestAPI = retrofit . create ( InterestAPI . class ); final Object body = interestAPI . getListInterests (). execute (). body (); return body . toString (); } Dropwizard ï Note See the Kafka Dropwizard to find all the remaining properties: . For more information, see the dropwizard-template repository,
which has Zipkin configured. For deeper knowledge about how to use the zipkin-core and zipkin-client library see: https://github.com/smoketurner/dropwizard-zipkin Note Replace {zipkin-core-version} with the latest version from the Maven Repository Replace {zipkin-client-version} with the latest version from the Maven Repository Replace {kafka-clients-version} with the latest version from the Maven Repository Set the following properties in config/config.yml : logging:
  appenders:
    - type: console
      logFormat: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId}/%X{spanId}] [%thread] %-5level %logger{36} - %msg %replace(%ex){'[\r\n]+', ''} %nopex %n"

zipkin:
  enabled: true
  collector: kafka
  bootstrapServers: ${KAFKA_NODES_AUTH}

zipkinClient:
  serviceName: dropwizard-template
  timeout: 2s Update pom.xml with: <properties>
    <zipkin-core.version>{zipkin-core-version}</zipkin-core.version>
    <zipkin-client.version>{zipkin-client-version}</zipkin-client.version>
    <kafka-clients.version>{kafka-clients-version}</kafka-clients.version>
</properties>
<dependency>
    <groupId>com.smoketurner.dropwizard</groupId>
    <artifactId>zipkin-core</artifactId>
    <version>${zipkin-core.version}</version>
</dependency>
<dependency>
    <groupId>com.smoketurner.dropwizard</groupId>
    <artifactId>zipkin-client</artifactId>
    <version>${zipkin-client.version}</version>
</dependency>
<dependency>
    <groupId>org.apache.kafka</groupId>
    <artifactId>kafka-clients</artifactId>
    <version>${kafka-clients.version}</version>
</dependency> Deploy the micro service as usual Usage - Application class ï Add ZipkinBundle to the application class: @Override public void initialize ( Bootstrap < DropwizardConfiguration > bootstrap ) { bootstrap . addBundle ( new ZipkinBundle < DropwizardConfiguration > ( getName ()) { @Override public ZipkinFactory getZipkinFactory ( DropwizardConfiguration configuration ) { return configuration . getZipkinFactory (); } }); } @Override public void run ( DropwizardConfiguration configuration , Environment environment ) throws Exception { Optional < HttpTracing > tracing = configuration . getZipkinFactory (). build ( environment ); } Usage - Configuration class ï Implement the ZipkinFactory in the configuration class: public class DropwizardConfiguration extends Configuration { @Valid @NotNull public final ZipkinFactory zipkin = new ConsoleZipkinFactory (); @Valid @NotNull private final ZipkinClientConfiguration zipkinClient = new ZipkinClientConfiguration (); @JsonProperty public ZipkinFactory getZipkinFactory () { return zipkin ; } @JsonProperty public ZipkinClientConfiguration getZipkinClient () { return zipkinClient ; } } Zipkin server ï Zipkin server is deployed as a standalone host on different environments. Each host contains of two components: Zipkin service Elasticsearch container Deploy ï Run deploy-zipkin playbook, see below example: ansible - playbook - i inventories / ossys playbooks / deploy - zipkin . yml -- extra - vars image_tag = '20230117114607-9c85137' -- extra - vars zipkin_version = 2.23.18 Note Latest image_tag can be found here in Nexus Update ï Note Remove both server and storage before running below instructions. Zipkin service update ï Download latest release of zipkin-server from here Upload the jar file to Nexus, sbab-software/zipkin repository Update zipkin version in roles/zipkin/defaults/main.yml Run the deploy-zipkin playbook Elasticsearch update ï Commit and push changes to this repo After successful Jenkins build then use the new created image tag and run the deploy-zipkin playbook. Trouble shooting ï In case of Zipkin server failure: Remove both server and storage and run the deploy-zipkin playbook again Previous Next © Copyright 2024, TNT. Built with Sphinx using a theme provided by Read the Docs .