Vagrant — SBAB Docs  documentation SBAB Docs Ansible Controller Ansible Roles Ansible Vault Argo Workflows Authentication & Authorization Bitbucket Boost Chatbot Booli Ceph Dex Fortigate troubleshooting Generate certificate Go GitHub Copilot GitLab @Sbab User Guide GitLab Maintenance Grafana Istio Java Jenkins Jenkinsfile Jmeter Kafka Maintenance Kafka @Sbab User Guide Kafka Connect Kubectl Access Kubernetes Lab environment Local Open Web Metrics infrastructure MongoDB Netbox NVIDIA Neo4J Sonatype Nexus repository Oracle OWASP Database OWASP @Sbab User Guide Pact Principles of Security Prometheus ReactJS Redis Renovate S3 Security Guidelines for Developers Sentry Maintenance Sentry User Guide Configuring Variables for Services Deployed to Kubernetes Software Architecture SonarQube Maintenance SonarQube User Guide Structurizr System Landscape Vagrant Installation Pre-requisites Windows Vagrant plugins Environment variables Machines Multi-machine setup Prerequisites Important Environment Variables Ansible Controller Secure & Open Web Deployment IS Deployment Debugging Nginx int/ext Deployment Kafka & Zookeeper User Guide 1. Clone repository 2. List Vagrant machines 3. Start a machine 4. SSH into a machine 5. Stop and destroy a machine SBAB box Getting started Initiate Configure Install VBoxGuestAdditions Cleanup before packaging Packaging Upload the box Update metadata Upload metadata file Update Vagrantfile Zipkin Windows Pipelines SBAB Docs » Vagrant View page source Vagrant ï Installation ï This Vagrant setup uses multiple virtual machines in a private network. /etc/hosts is automatically updated for both the host and guests machines. A separate Ansible Controller is setup as the default machine. This means that certain commands,
such as vagrant ssh will use this machine. Pre-requisites ï Install Vagrant Install VirtualBox Windows ï Install Chocolatey Install Cygwin : choco install cygwin To access your Windows area in Cygwin, navigate to: /cygdrive/c/Users/{user} Alternatively, it is possible to change Cygwin home directory to be the same as Windows Vagrant plugins ï vagrant-hostmanager vagrant-proxyconf vagrant-vbguest vagrant-share Installation command: make install-plugins Environment variables ï For each required variable, make sure to: Clone the Git repo Set the environment variable to the local path of the repo Windows example: setx MODSECURITY_SOURCE C : \ Users \ { user } \ dev \ modsecurity Mac example: echo export "MODSECURITY_SOURCE=/Users/ {user} /dev/modsecurity" >> ~/. bash_profile source ~/. bash_profile Machines ï The machines are currently: Machine name Alias Purpose sec Secure Web, IB, Internet Banken Local machine for the logged in part of www.sbab.se/logga-in www Web, Open Web, Webben Local machine for the non-logged in part of www.sbab.se is Weblogic Server administration console nginx-int Nginx Internal Internal load balancer nginx-ext Nginx External External load balancer ansible Ansible Controller Provision all other machines Multi-machine setup ï As a part of the Ansible project, we provide a Vagrant setup directory, which can be used
to setup test-vmâs on your local machine for debugging and testing while developing. Prerequisites ï To be able to use this setup, you must install software on your local machine for running
Vagrant. Install Vagrant. Please, see the Vagrant documentation , for installation guides Install VirtualBox. Please, see the Virtualbox documentation , for installation guide Install Vagrant plugins needed for running out Multi-machine setup, to do this
please run the command below in a Terminal / Command-prompt: vagrant plugin install vagrant-hostmanager \ vagrant-proxyconf \ vagrant-share \ vagrant-vbguest Important Environment Variables ï Listed below are some environment variables that are important to know about, and to consider
while setting up your test-vmâs. Most of which, have the purpose to point vagrant to your local
source code directory for the software you are testing/debugging, which will allow you to test
your own local code changes. NGINX_SOURCE path to LGC/nginx repo checkout MODSECURITY_SOURCE path to SAK/modsecurity repo checkout WEBBEN_SOURCE path to LGC/webben repo checkout IS_DOMAIN_ROOT path to LGC/is-domain repo checkout IS_DOMAIN_TEMPLATE_ROOT path to LGC/is-domain-template repo checkout IS_EXTCOMP_ROOT path to LGC/is-extcomp repo checkout Note These environment variables needs to be set on your local machine, and not on any of the vms created by vagrant. Ansible Controller ï The first machine to setup is the Ansible-controller, this is used to setup and configure
all other machines in the Vagrant setup. This VM is important, since it will use Ansible to configure other vm instances, and deploy and configure the correct software. To create and start this vm on your local machine, you will need to run the following
command in your Terminal/Command-prompt: Note Your current working directory has to be the ansible/vagrant directory before running any vagrant commands vagrant up ansible Running this command will take a while, since it will create the Virtual Machine needed before
installing and configuring Ansible and the needed keys and config for running Ansible deployments
on other local vms, or remote machines in our testing environments. When the setup of the vm is finnished, you can login to the machine by running Note Your current working directory has to be the ansible/vagrant directory before running any vagrant commands vagrant ssh ansible Congrats! Now you are in the environment from which you will be able to setup and configure other local
vms for local testing and debugging of some of our software. Log out by pressing Ctrl+D , because before attempting to setup any other vm, you will need to run vagrant up $vm for
the machines you need running locally. This is required to be able to test and debug your local changes (replace $vm with the name of the vm you want to deploy). Secure & Open Web ï Note Before using this, please make sure to setup the Ansible Controller first! To set up a local deployment of Secure or Open Web to test and debug your code changes, you will need
to follow some specific steps to get it up and running with Sitevision inside a VM. As the steps to set this up are almost exactly the same for both Open and Secure web, we combine these two inside
this single guide. Deployment ï Note If your reason to set up Secure and Open Web locally is to test your local source code revision, you will
need to set the WEBBEN_SOURCE environment variable, to point to your local directory containing
the source code of Webben. To create the virtual machine to run on, you will need to execute one of the following commands: Note Your current working directory has to be the ansible/vagrant directory before running any vagrant commands vagrant up sec # secure web vagrant up www # open web This will only create the vm, with the correct OS and configuration to allow secure web to be installed. Now you will need to login to the Ansible Controller by executing the following: Note Your current working directory has to be the ansible/vagrant directory before running any vagrant commands vagrant ssh ansible Once inside the Ansible Controller , the login message will announce a list of possible command aliases
the alias you should use is sec for Secure web and www for Open web, you can use these aliases by
simply executing them as commands in the Ansible Controllers shell. The alias commands maps to much longer ansible-playbook commands, so the execution will run for a while.
After running your alias command, you should have successfully deployed and installed your local copy of Secure
or Open web. Note It is possible to have both Open Web and Secure Web running on your local machine simultaneously You should be able to browse to your local installations by the following links Open Web http://sysi2.sbab.se Secure Web http://sysi2-ib.sbab.se Note Please refer to the projects readme for re-deploying changes in source code IS ï Note Before using this, please make sure to setup the Ansible Controller first! To set up a local deployment of IS to test and debug your code changes, you will need
to follow some specific steps to get it up and running with Weblogic inside a VM. Deployment ï Note If your reason to set up IS locally is to test your local source code revision, you will
need to set the IS_DOMAIN_ROOT environment variable, to point to your local directory containing
the source code of IS-Domain. To create the virtual machine to run on, you will need to execute one of the following commands: Note Your current working directory has to be the ansible/vagrant directory before running any vagrant commands vagrant up is This will only create the vm, with the correct OS and configuration to allow secure web to be installed. Now you will need to login to the Ansible Controller by executing the following: Note Your current working directory has to be the ansible/vagrant directory before running any vagrant commands vagrant ssh ansible Once inside the Ansible Controller , the login message will announce a list of possible command aliases
the alias you should use is is , you can use the alias by simply executing it as a commands in the Ansible
Controllers shell. The alias commands maps to much longer ansible-playbook commands, so the execution will run for a while.
After running your alias command, you should have successfully deployed and installed your local copy of Nginx. Note Please refer to the projects readme for re-deploying changes in source code Debugging ï To add debugging for your locally running IS instance in IDEA, you will need to follow these steps. Add a new Run configuration of the Remote type Input the necessary configuration options for your local instance Host is-dev-i1-1.sbab.se Port 5000 JDK 5 - 8 Remote JVM args -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5000 Module classpath Choose the module you want to debug It should look something like this, for debugging the www-open-services module: Nginx int/ext ï Note Before using this, please make sure to setup the Ansible Controller first! In all of our environments we have one internal and one external Nginx reverse proxy. The main difference between these
proxies is what should be reachable through them. The external proxy is used for traffic coming from the internet, while
the internal proxy should only be used for internal traffic. This way we should be able to better control what is reachable from the open internet. Deployment ï Note If your reason to set up Secure Web locally is to test your local source code revision, you will
need to set the NGINX_SOURCE and MODSEC_SOURCE environment variables, to point to your local directory
containing the source of our internal Nginx project. To create the virtual machine to run on, you will need to execute one of the following commands: Note Your current working directory has to be the ansible/vagrant directory before running any vagrant commands vagrant up nginx-int nginx-ext This will only create the vm, with the correct OS and configuration to allow secure web to be installed. Now you will need to login to the Ansible Controller by executing the following: Note Your current working directory has to be the ansible/vagrant directory before running any vagrant commands vagrant ssh ansible Once inside the Ansible Controller , the login message will announce a list of possible command aliases
the alias you should use is nginx , you can use the alias by simply executing it as a commands in the Ansible
Controllers shell. If you make changes to the configuration, that you would like to test locally, just take step 2 and 3 again, and the
configuration should be updated and Nginx instances should be reloaded. Kafka & Zookeeper ï Warning This vagrant setup seems to be outdated [2020-01-07], please contact Team TNT if this is
something you need for your local development environment. Most people use our Kafka
clusters in our sys environment for local testing. Tip To read about how to configure your kafka client, please see: Client configuration Note Before using this, please make sure to setup the Ansible Controller first! If you would want to run a single-node kafka machine on your local machine, for testing
kafka related things, you can use this Vagrant setup to achieve that. This Vagrant setup is intended to be a plug&play option, if you want to run outside of
our SBAB internal test environments. The setup is ideal if you do not want to clutter the
Kafka topics of your service with a lot of unwanted test records. To create the vmâs you can run Note Your current working directory has to be the ansible/vagrant directory before running any vagrant commands vagrant up kafka After creating the vm you will need to run the following in your Ansible-controller vm, for
Ansible to install and configure the Kafka and Zookeeper software. ansible-playbook -i inventory/test playbooks/kazoo.yml User Guide ï Tip To see all virtual machines, see: Machines For more detailed information, read the Vagrant CLI docs . 1. Clone repository ï Clone afto/ansible : git clone ssh : // git @stash . sbab . se : 7999 / afto / ansible . git Change to the vagrant directory: cd ansible / vagrant 2. List Vagrant machines ï To see all machines with their corresponding status, simply run: vagrant status For more information about a specific machine: vagrant status { name } 3. Start a machine ï It is recommended to start one machine at the time: vagrant up { name } It is also possible to specify a regular expression to start multiple machines, e.g: sec , nginx-int , nginx-ext , is and ansible : vagrant up "/sec|nginx.*|is|ansible/" 4. SSH into a machine ï To SSH into one of the machines: vagrant ssh { name } 5. Stop and destroy a machine ï To stop a machine: vagrant halt { name } To stop and delete all traces of the vagrant machine: vagrant destroy { name } SBAB box ï Note Should only be done if we need to update our Centos base box. Contact TnT to do this This guide describes the steps needed to setup to create a SBAB Vagrant box Getting started ï Vagrant provides a guide for getting started at vagrantup.com You may also like to checkout the ansible repo for an example showing howto setup IS using Vagrant,
VirtualBox and Ansible. Navigate to the vagrant/is subfolder. Initiate ï Initiate an AlmaLinux Vagrant bob vagrant box add almalinux/8 --provider virtualbox
vagrant init almalinux/8 Add blow code to Vagrantfile if Vagrant.has_plugin? "vagrant-vbguest" config.vbguest.no_install = true config.vbguest.auto_update = false config.vbguest.no_remote = true end

config.ssh.insert_key = false config.vm.synced_folder "." , "/vagrant" , disabled: true config.vm.provider "virtualbox" do | vb | vb.gui = true vb.memory = "2048" end Then run: vagrant up Configure ï Log in to VirtualBox GUI, user/password = root/vagrant usermod -u 1200 vagrant
groupmod -g 1200 vagrant Run vagrant ssh
su - root export http_proxy = http://trend3.sbab.ad:8080 export https_proxy = http://trend3.sbab.ad:8080 Add below proxy settings to /etc/yum.conf: proxy = http : // trend3 . sbab . ad : 8080 And the run yum update -y
yum install gcc kernel-devel kernel-headers make bzip2 perl wget elfutils-libelf-devel -y

/sbin/shutdown -r now Install VBoxGuestAdditions ï We need to do this for every new release of VirtualBox vagrant ssh
su - root

yum update kernel -y
sudo /sbin/shutdown -r now

vagrant ssh
su - root

yum groupinstall "Development tools" -y
wget https://download.virtualbox.org/virtualbox/6.1.34/VBoxGuestAdditions_6.1.34.iso
mkdir /media/VBoxGuestAdditions
mount -o loop,ro VBoxGuestAdditions_6.1.34.iso /media/VBoxGuestAdditions
sh /media/VBoxGuestAdditions/VBoxLinuxAdditions.run
rm VBoxGuestAdditions_6.1.34.iso
umount /media/VBoxGuestAdditions
sudo rmdir /media/VBoxGuestAdditions
sudo /etc/init.d/vboxadd setup Cleanup before packaging ï Remove proxy=http://trend3.sbab.ad:8080 from /etc/yum.conf Create the ansible vault password file (can be obtained from Ansible vault) history -c exit su - vagrant cd ~
mkdir .ansible cd .ansible echo -n Password: ; read -s password ; echo $password > .avp history -c Packaging ï In VirtualBox GUI, find out the name of the vm (e.g. default_1653939076813_57613): vagrant package -- base < "box name from VirtualBox GUI" > The box will be created in the current folder with name: package.box Test the box using a named box:
vagrant box add mybox <path to the box> âprovider virtualbox
Name of the new box is mybox. Upload the box ï Upload the new box âpackage.boxâ to Nexus Software repository.
Check the latest version in Nexus and increase the minor version. e.g.: curl - v -- user '<username>:<password>' -- upload - file package . box http : // nexus . common . sbab . se : 8081 / repository / sbab - software / vagrant / almalinux - 8 - sbab / almalinux - 8 - sbab - 1.2.0 . box Update metadata ï Download the latest metadata-1.0.json from Nexus Add the new box version in the versions json array Update the url for the new box Update the sha1 checksum. The checksum can be fetched from the nexus.box.sha1
file located next to the newly uploaded .box file { "name" : "almalinux-8-sbab" , "description" : "This box contains the SBAB base box derived from the almalinux/8 box, vagrant user/group moved to id 1200/1200, dnf update and ~/.ansible/.avp password added" , "versions" : [ { "version" : "1.1.0" , "providers" : [ { "name" : "virtualbox" , "url" : "http://nexus.common.sbab.se:8081/repository/sbab-software/vagrant/almalinux-8-sbab/almalinux-8-sbab-1.1.0.box" , "checksum_type" : "sha1" , "checksum" : "98e65fbeff7989797ea559feacee3341737d8dc8" } ] }, { "version" : "1.2.0" , "providers" : [ { "name" : "virtualbox" , "url" : "http://nexus.common.sbab.se:8081/repository/sbab-software/vagrant/almalinux-8-sbab/almalinux-8-sbab-1.2.0.box" , "checksum_type" : "sha1" , "checksum" : "eaff46ed83c190a3211a6ac783af3b8c33b795ad" } ] } ] } Upload metadata file ï Upload: curl - v -- user '<username>:<password>' -- upload - file metadata - 1.0 . json http : // nexus . common . sbab . se : 8081 / repository / sbab - software / vagrant / almalinux - 8 - sbab / metadata - 1.0 . json Update Vagrantfile ï Update config.vm.box_version to use
the new box. Previous Next © Copyright 2024, TNT. Built with Sphinx using a theme provided by Read the Docs .