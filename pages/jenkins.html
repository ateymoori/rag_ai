Jenkins — SBAB Docs  documentation SBAB Docs Ansible Controller Ansible Roles Ansible Vault Argo Workflows Authentication & Authorization Bitbucket Boost Chatbot Booli Ceph Dex Fortigate troubleshooting Generate certificate Go GitHub Copilot GitLab @Sbab User Guide GitLab Maintenance Grafana Istio Java Jenkins Jenkins Master Playbook Upgrade version Rollback Add a new Jenkins plugin Jenkins slaves Re-create Jenkins build slaves Re-create Ansible Controllers Re-connect Jenkins slaves Build management system Gradle Local global settings Services Libraries How to upgrade Owasp Maven plugin Upgrade Roll back Certificate renewal Jenkinsfile Jmeter Kafka Maintenance Kafka @Sbab User Guide Kafka Connect Kubectl Access Kubernetes Lab environment Local Open Web Metrics infrastructure MongoDB Netbox NVIDIA Neo4J Sonatype Nexus repository Oracle OWASP Database OWASP @Sbab User Guide Pact Principles of Security Prometheus ReactJS Redis Renovate S3 Security Guidelines for Developers Sentry Maintenance Sentry User Guide Configuring Variables for Services Deployed to Kubernetes Software Architecture SonarQube Maintenance SonarQube User Guide Structurizr System Landscape Vagrant Zipkin Windows Pipelines SBAB Docs » Jenkins View page source Jenkins ï Jenkins is an automation tool for Continuous Integration, used to build, test and deploy code. Jenkins Master Playbook ï Run this from the Ansible Controller (replace jenkins11 if needed): ansible - playbook - i inventories / oscommon playbooks / jenkins . yml \ -- limit jenkins11 \ -- tags always \ -- extra - vars docker_compose_pull = True \ -- extra - vars docker_compose_redeploy = True \ -- extra - vars jenkins_container_image = nexus . common . sbab . se : 18443 / se . sbab / jenkins - java - 11 Upgrade version ï Warning Upgrades should preferably be done before 08:00, at 11:00 or after 17:00 Swedish time. To update Jenkins version to the latest version: Announce that Jenkins will be updated and down for a while: #planned-production-disruption #testenvironments Prepare a rollback by writing down the current Docker image: os common jenkins11 sudo docker ps Build a new jenkins-centos Docker image and locate the image tag Navigate to Manage Jenkins and click the Prepare for Shutdown button Run the Jenkins Master Playbook Wait until you see Jenkins is fully up and running in Splunk (sort by _time descending) Build a Jenkins job and deploy it to all environments. Rollback ï Simply run the Jenkins Master Playbook with an older jenkins-centos Docker image tag. Add a new Jenkins plugin ï Add the new plugin to plugins.txt Run the Jenkins Master Playbook Configure the new plugin using Jenkins webgui Jenkins slaves ï We have two types of Jenkins slaves: Build slaves, e.g jenkins-s-1 and jenkins-s-2 Ansible Controllers, e.g jenkins-ac-stage-1 and jenkins-ac-prod-2 Re-create Jenkins build slaves ï Navigate to the Build Executors and mark the desired node as offline Wait until no builds are running Delete the slave, in this example jenkins-s-1 from the 2nd server hall: openstack -- os - cloud = common2 server delete jenkins - s - 1 Navigate to the ansible-jenkins-slave job and click the Build Now button Run owasp-updater-job job. Re-create Ansible Controllers ï Navigate to the Build Executors and mark the desired node as offline Wait until no builds are running Delete the slave, in this example jenkins-ac-stage from the 1st server hall: openstack -- os - cloud = common1 server delete jenkins - ac - stage Run this from the Ansible Controller : ansible - playbook -- inventory inventories / oscommon playbooks / ansible - controller - setup . yml -- limit jenkins - ac - stage Follow these steps: https://confluence.sbab.se/display/TTTT/Special+handling+for+jenkins-ac-prod+servers Re-connect Jenkins slaves ï Tip Run this to re-connect all slaves at once: ansible -- inventory inventories / oscommon - m systemd -- args = "name=jenkins-swarm-client state=restarted" jenkins - all - slaves Locate all slaves in inventories/oscommon/hosts : They all start with: jenkins- SSH to the Jenkins slave, e.g: os common jenkins - s - 1 Restart Jenkins Swarm Client: sudo systemctl restart jenkins - swarm - client Repeat for all other Jenkins slaves Build management system ï Gradle ï It is now possible to build JVM based languages using Gradle. Same Jenkinsfiles for building Java service and libraries
can be used, see Jenkinsfile . Local global settings ï Add below files to your gradle home folder, ~/.gradle gradle.properties systemProp.http.proxyHost = trend3.sbab.ad
systemProp.http.proxyPort = 8080 systemProp.http.nonProxyHosts = localhost | 127 .0.0.1 | *.sbab.se | *.sbab.ad
systemProp.https.proxyHost = trend3.sbab.ad
systemProp.https.proxyPort = 8080 systemProp.https.nonProxyHosts = localhost | 127 .0.0.1 | *.sbab.se | *.sbab.ad
org.gradle.daemon = true nexus_username = jenkins nexus_password = jenkins init.gradle allprojects { repositories { mavenLocal () maven { url "http://nexus.common.sbab.se:8081/repository/maven-public" } } buildscript { repositories { mavenLocal () maven { url "http://nexus.common.sbab.se:8081/repository/maven-public" } } } } Services ï Below configurations must be added to your project configuration files:
( Service project example ) build.gradle A group property e.g. group = 'se.sbab.tnt' Configuration for jar task jar { archivesBaseName = 'kotlin-spring-template-service' archiveVersion = '1.0-SNAPSHOT' } A copy task to copy jar file to target folder task copyJarToBin ( type: Copy ) { from "build/libs/${archivesBaseName}.jar" into "target" } Project structure A âConfigâ folder with environment variables for each environment on Swarm (sys, acc, stage and prod). Integration tests (if there are any): Create a folder under âsrcâ folder so called integrationTest Add a gradle file integration-test.gradle sourceSets { integrationTest { compileClasspath += sourceSets . main . output + configurations . testCompile runtimeClasspath += output + compileClasspath + configurations . testRuntime } } task integrationTest ( type: Test ) { description = 'Runs the integration tests.' group = 'verification' testClassesDirs = sourceSets . integrationTest . output . classesDirs classpath = sourceSets . integrationTest . runtimeClasspath outputs . upToDateWhen { false } mustRunAfter test } check . dependsOn integrationTest In build.gradle file add this apply from: "$rootDir/integration-test.gradle" Libraries ï Below configurations must be added to your project configuration files:
( Library project example ) gradle.properties Add below properties: Default snapshot version externalVersion=1.0-SNAPSHOT Group id e.g. groupId=se.sbab.tnt build.gradle Maven publish plugin apply plugin: 'maven-publish' A group property e.g. group = groupId A version property version = externalVersion Configuration for publishing task //If code source needs to be uploaded task sourcesJar ( type: Jar ) { from sourceSets . main . allJava archiveClassifier = 'sources' } //If doc needs to be uploaded task javadocJar ( type: Jar ) { from javadoc archiveClassifier = 'javadoc' } //Mandatory publishing { repositories { maven { credentials { username "${nexus_username}" password "${nexus_password}" } def releasesRepoUrl = "http://nexus.common.sbab.se:8081/repository/maven-releases" def snapshotsRepoUrl = "http://nexus.common.sbab.se:8081/repository/maven-snapshots" url = version . endsWith ( 'SNAPSHOT' ) ? snapshotsRepoUrl : releasesRepoUrl } } publications { mavenJava ( MavenPublication ) { artifactId = 'kotlin-template-lib' //change to your artifact-id, usually same as repo name from components . java artifact sourcesJar //If code source needs to be uploaded artifact javadocJar //If doc needs to be uploaded pom { //If you need to add additional information in pom name = 'kotlin-template-lib' description = 'Kotlin lib template' } } } } How to upgrade Owasp Maven plugin ï Upgrade ï Note Testing on Jenkins agents and upgrade should preferably be done during non-office hours. First of all test the new plugin version on a local machine by following this guide Choose a âfreeâ Jenkins agent and remove the Jenkins labels BUILD-OS AGILE android . Create a branch from owasp-db-updater repo and modify the Jenkinsfile as below to run the updater on one agent #!/usr/bin/env groovy @Library ( 'tnt-shared-library' ) _ def names = nodeNames (). grep ( 'jenkins-s1-ki-37aa5905' ) for ( int i = 0 ; i < names . size (); ++ i ) { def nodeName = names [ i ]; node ( nodeName ) { echo "Triggering on " + nodeName stage ( "OWASP Update " + nodeName ) { checkout scm env . JAVA_HOME = "${tool 'Java-8'}" env . PATH = "${env.JAVA_HOME}/bin:${env.PATH}" mvn ( "-B -s settings.xml org.owasp:dependency-check-maven:6.1.2:update-only -DmavenSettingsProxyId=trend3_http" ) } } } @NonCPS def nodeNames () { return jenkins . model . Jenkins . instance . nodes . collect { node -> node . name } } Push the branch and see if all OWASP databases will get updated without any problem. Create a branch from jenkins-pipeline repo and update the version of Owasp maven plugin in this file and fix corresponding tests. Run a number of Java projects on the agent with updated database with the branch of jenkins-pipeline created in previous step. if successful: Merge the jenkins-pipeline changes to master. Modify the Owasp maven plugin version in owasp-db-updater repo (dev) and push. Remove the feature branch created in step 3. Roll back ï Disable Jenkins agent used in previous section and recreate it using Ansible playbook. Certificate renewal ï Run the Makefile-Jenkins in Docker, see the repository README.md Update jenkins.server.keystore.jks.orig with the newly generated file Run the Jenkins Master Playbook Previous Next © Copyright 2024, TNT. Built with Sphinx using a theme provided by Read the Docs .