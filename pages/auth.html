Authentication & Authorization — SBAB Docs  documentation SBAB Docs Ansible Controller Ansible Roles Ansible Vault Argo Workflows Authentication & Authorization Authentication OAuth2 and partner-auth-service Service user Employee Mock login Customer Phone codes Legacy WebServices Authorization JWT eDirectory Legacy Intellij ActiveDirectory Bitbucket Boost Chatbot Booli Ceph Dex Fortigate troubleshooting Generate certificate Go GitHub Copilot GitLab @Sbab User Guide GitLab Maintenance Grafana Istio Java Jenkins Jenkinsfile Jmeter Kafka Maintenance Kafka @Sbab User Guide Kafka Connect Kubectl Access Kubernetes Lab environment Local Open Web Metrics infrastructure MongoDB Netbox NVIDIA Neo4J Sonatype Nexus repository Oracle OWASP Database OWASP @Sbab User Guide Pact Principles of Security Prometheus ReactJS Redis Renovate S3 Security Guidelines for Developers Sentry Maintenance Sentry User Guide Configuring Variables for Services Deployed to Kubernetes Software Architecture SonarQube Maintenance SonarQube User Guide Structurizr System Landscape Vagrant Zipkin Windows Pipelines SBAB Docs » Authentication & Authorization View page source Authentication & Authorization ï On this page we will try to explain how authentication and authorization works at SBAB using practical examples.
The target audience is mainly developers. All examples below will use the sys environment. Note In simple terms, authentication is the process of verifying who a user is, while authorization is the process of
verifying what they have access to. In SBAB we have 3 type of users: Customer Employee Service user Authentication ï In the first section, the different ways to perform authentication will be described. OAuth2 and partner-auth-service ï We strive to delegate all authentication towards the partner-auth-service using OAuth2.
In this case the information needed to perform the authentication can be provided in different ways, called flows. For example: BankID Username and password Kerberos ticket Certificate Mock user The result of a successful authentication using OAuth2 is an access-token in UUID format and a corresponding
JWT ( JSON Web Token ), stored in partner-auth-service (PAS). Service user ï LetÂ´s start with a simple example where a service needs to initiate a REST call to another service. In this case, the
call is not initiated by an employee or customer clicking for example a button, so there is no authenticated user.
In this case, the best choice is likely to use a service user with client credentials grant type. The user in this example will be microservice with the password bytkod . In the client credential flow, the
username and password will be sent using the Authorization HTTP header with a Basic prefix, either in clear
text <username>:<password> or base64 encoded. curl - X POST -- location "https://k8sproxy.sys.sbab.se/partner-auth-service/v1/auth/token" \ - H "accept: application/json" \ - H "Content-Type: application/x-www-form-urlencoded" \ - d "grant_type=client_credentials" \ -- basic -- user microservice : bytkod Tip Go to the online base64 encoder and paste in microservice:bytkod . The result will be bWljcm9zZXJ2aWNlOmJ5dGtvZA== . This should be sent in the Authorization HTTP header field with
the Basic prefix: Authorization: Basic bWljcm9zZXJ2aWNlOmJ5dGtvZA== curl - X POST -- location "https://k8sproxy.sys.sbab.se/partner-auth-service/v1/auth/token" \ - H "Authorization: Basic bWljcm9zZXJ2aWNlOmJ5dGtvZA==" \ - H "accept: application/json" \ - H "Content-Type: application/x-www-form-urlencoded" \ - d "grant_type=client_credentials" in either case the result will be similar to this JSON response: { "access_token" : "6f61b2fc-1e30-4c02-b312-a3b1821914f9" , "expires_in" : 28800 , "token_type" : "bearer" } This access token can now be used to call the target service with the HTTP Authorization header using the Bearer prefix or as a GWTOKEN cookie: curl - X GET -- location "https://k8sproxy.sys.sbab.se/prior-information-service/api/v1/prior-information/effective-interest-rate?interestRate=0.0159&loanAmount=1500000" \ - H "Authorization: Bearer 6f61b2fc-1e30-4c02-b312-a3b1821914f9" curl - X GET -- location "https://k8sproxy.sys.sbab.se/prior-information-service/api/v1/prior-information/effective-interest-rate?interestRate=0.0159&loanAmount=1500000" \ -- cookie "GWTOKEN=6f61b2fc-1e30-4c02-b312-a3b1821914f9" JSON response: { "effectiveInterestRate" : 0.0160166 } Note The "expires_in": 28800 is the number of seconds that this token will be valid, i.e. 8 hours in this example.
Make sure to fetch a new access token for the service user well before the token expires. Employee ï SBAB employees accessing internal systems, such as PÃ¥rtalen or Cortex relies on single-sign-on using Kerberos.
You need to be logged in to NoMAD in the menu bar in order to use Kerberos login. Tip You can use klist command line tool to display current Kerberos tickets. Warning Google updated two enterprise keys with Chrome version 86. AuthNegotiateDelegateWhitelist and AuthServerWhitelist have been renamed to AuthNegotiateDelegateAllowlist and AuthServerAllowlist . Run the following commands to update: defaults write com.google.Chrome AuthServerAllowlist "*.sbab.se" defaults write com.google.Chrome AuthNegotiateDelegateAllowlist "*.sbab.se" defaults remove com.google.Chrome AuthServerWhitelist
defaults remove com.google.Chrome AuthNegotiateDelegateWhitelist After restarting Chrome Kerberos should be working again. You should now be able to log into a singe-sign-on enabled UI, like for instance Cortex using the Logga in button. The assigned access token should now have been set as a secure Cookie named GWTOKEN . Tip Check the Chrome network traffic tab to see the call that fetches the access-token. For sys, the Nginx
loadbalancer at https://lbsys-i10-intern.sbab.se:18835 must be used. For instance: https://lbsys-i10-intern.sbab.se:18835/partner-auth-service/v1/auth/authorize?client_id=cortex&response_type=token&redirect_uri=https:%2F%2Fcortex-sys.sbab.se&callback=__jp1&_=1660035325671 Response: { "access_token" : "70ebe257-8cc8-413e-bc82-3bf0fcb40a5b" , "expires_in" : 43200 , "token_type" : "bearer" } Mock login ï For testing purposes it is sometimes useful to be able to login as a mock user with the possibility to override
authorization skills. This can be done using the partner-auth-service mockauth/authorize or mockauth/mockraw endpoint. The following authorize request will be sent when a mock user is requested in Cortex: https://lbsys-i10-intern.sbab.se:18835/partner-auth-service/v1/mockauth/authorize?client_id=cortex&response_type=token&redirect_uri=https:%2F%2Fcortex-sys.sbab.se&user_id=pknu&callback=__jp0&_=1660039959212

https://lbsys-i10-intern.sbab.se:18835/partner-auth-service/v1/mockauth/mockraw?user_id=ppa&client_id=cortex&skill=cortexViewLoanApplication,cortexEditLoanApplication,cortexMaintainer Response: { "access_token" : "72ddc52b-fe55-41af-8b68-bef8170e1edb" , "expires_in" : 43200 , "token_type" : "bearer" } Customer ï Logging is as an SBAB customer on secure web can be done using either a BankID issued for test or the Quick Auth app that can be downloaded from Self Service. Finding a customer for test can be done in different ways, for instance: Use the SBAB test tool Use the Slack Test Data Bot . Type the name of the environment, for instance sysi1 or acc and the bot will
respond with a few random test customers. Copy the given NIN for the test customer into the Quick Auth app. From the app, you get direct access to both the
access-token and the corresponding JWT. The Login button will take you directly to secure web in the given
target test environment. Creating a BankID for test is described on confluence Note Creating a BankID for test should only be used when testing the BankID login flow. Phone codes ï Customers calling SBAB can also be identified by using a phone code. Phone codes are generated by the security-service when printed and are stored in eDirectory in a hashed way under the node Telefonkder ou=Telefonkoder,ou=Privatspar,ou=InternetBank,o=Sbab . Once a phone code is assigned to a user, it is removed from the Telefonkoder node and the information is stored as
attributes in the customer node. For example cn=191502012477,ou=Kunder,ou=Privatspar,ou=InternetBank,o=Sbab : Attribute description Value SparisTelefonKod 3c5c0f8620fb1293c0917c3980ad5052d4eff749 SparisUserSalt gJwQaKjenVaNlUk224QNadcUQdraZh3GjzvlfxEX SparisTelefonRaknare 0 When the calling customer verifies using a phone code, it is sent to the security-service verifieraTelefonkod SOAP
method, where the the same hash function is executed to generate the SparisTelefonKod and compare the result.
The authorization is successful if the values matches. If the wrong phone code is given, the SparisTelefonRaknare field is incremented. If the max number of invalid attempts (3) is reached, the phone code is invalidated (removed).
A successful verification will reset the SparisTelefonRaknare back to zero. Legacy WebServices ï The Legacy IS system is mainly based on SOAP based WebServices. In order to make an authenticated request to IS, using
for instance SoapUI, a security header must be added to the request. The User can be either a service user or an SBAB
customer. The first example will use a service user to make a SOAP request using SoapUI to IS in sysi1.
The endpoint used in this example is http://is-sys-i1-1.sbab:7003/ISK_WS/SECURITY_KundinfoService <SOAP-ENV:Envelope xmlns:SOAP-ENV= "http://schemas.xmlsoap.org/soap/envelope/" > <SOAP-ENV:Header> <sbab:AuditId SOAP-ENV:actor= "http://audit.sbab.se/actor/" xmlns:sbab= "http://audit.sbab.se/audit/" > SEC-dd495c6c-e308-457b-8dc2-60d4779cd46e </sbab:AuditId> <wsse:Security xmlns:wsse= "http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" > <wsse:UsernameToken xmlns:wsu= "http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" > <wsse:Username> sys_securityws </wsse:Username> <wsse:Password Type= "http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText" > bytkod </wsse:Password> </wsse:UsernameToken> </wsse:Security> </SOAP-ENV:Header> <SOAP-ENV:Body> <ns3:hamtaKundbehorighet xmlns:ns2= "java:se.sbab.isk.api.security.modell" xmlns:ns3= "http://isk.sbab.se" xmlns:ns4= "java:se.sbab.isk.api.ws.exception" > <ns3:request> <ns2:Personnummer> 195003204475 </ns2:Personnummer> </ns3:request> </ns3:hamtaKundbehorighet> </SOAP-ENV:Body> </SOAP-ENV:Envelope> Response: <env:Envelope xmlns:env= "http://schemas.xmlsoap.org/soap/envelope/" > <env:Header> <sbab:AuditId env:actor= "http://audit.sbab.se/actor/" xmlns:sbab= "http://audit.sbab.se/audit/" > SEC-dd495c6c-e308-457b-8dc2-60d4779cd46e </sbab:AuditId> </env:Header> <env:Body> <m:hamtaKundbehorighetResponse xmlns:m= "http://isk.sbab.se" > <m:return> <java:Inlaningskund xmlns:java= "java:se.sbab.isk.api.security.modell" > false </java:Inlaningskund> <java:Utlaningskund xmlns:java= "java:se.sbab.isk.api.security.modell" > true </java:Utlaningskund> <java:Fondkund xmlns:java= "java:se.sbab.isk.api.security.modell" > false </java:Fondkund> <java:Transaktionskonto xmlns:java= "java:se.sbab.isk.api.security.modell" > false </java:Transaktionskonto> <java:HarAktivaPrivatlan xmlns:java= "java:se.sbab.isk.api.security.modell" > false </java:HarAktivaPrivatlan> <java:HarEndastAktivaPrivatlan xmlns:java= "java:se.sbab.isk.api.security.modell" > false </java:HarEndastAktivaPrivatlan> </m:return> </m:hamtaKundbehorighetResponse> </env:Body> </env:Envelope> The security header in this case adds the username sys_securityws and password bytkod . The authentication in
this case will use the WebLogic realm connected to eDirectory in sys. The next example will call an IS WebService as an SBAB customer. This case is a bit more complicated since the user must
have a valid secure web session. The username and password for such a session is created by exchanging a valid
access-token from partner-auth-service in the security-service . The endpoint used in this example is http://is-sys-i1-1.sbab.se:7003/ISK_WS/PartinfoService Fetch a valid access token from partner-auth-service using the Quick Auth app described above. Use the Copy Access Token button for a valid NIN (for example 197807122010). Use the access token to get a valid login session from security-service : https://k8sproxy.sys.sbab.se/security-service/user/login?access_token=b7f23293-2794-4283-bbce-780c3c33ed73 { "id" : "197811153134" , "certificate_issuer" : "sbab" , "reference_id" : "b7f23293-2794-4283-bbce-780c3c33ed73" , "internetbank_kund" : true , "registrerad" : true , "webservice_username" : "197811153134" , "webservice_password" : "b7f23293-2794-4283-bbce-780c3c33ed73" , "certificate_common_name" : "abcd" } Use the webservice_username and webservice_password from the response above in the SOAP security header: <soapenv:Envelope xmlns:soapenv= "http://schemas.xmlsoap.org/soap/envelope/" xmlns:isk= "http://isk.sbab.se" > <soapenv:Header> <wsse:Security xmlns:wsse= "http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" > <wsse:UsernameToken xmlns:wsu= "http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" > <wsse:Username> 197811153134 </wsse:Username> <wsse:Password Type= "http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText" > b7f23293-2794-4283-bbce-780c3c33ed73 </wsse:Password> </wsse:UsernameToken> </wsse:Security> </soapenv:Header> <soapenv:Body> <isk:hamtaFysiskPerson> <isk:personnummer> 197811153134 </isk:personnummer> </isk:hamtaFysiskPerson> </soapenv:Body> </soapenv:Envelope> Response: <env:Envelope xmlns:env= "http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi= "http://www.w3.org/2001/XMLSchema-instance" > <env:Header> <sbab:AuditId env:actor= "http://audit.sbab.se/actor/" xmlns:sbab= "http://audit.sbab.se/audit/" > IS-d9aa48f5-608d-405c-bd95-0de066ce71db </sbab:AuditId> </env:Header> <env:Body> <m:hamtaFysiskPersonResponse xmlns:m= "http://isk.sbab.se" > <m:return> <java:Partid xmlns:java= "java:se.sbab.isk.api.intern.modell" > 1230041 </java:Partid> <java:Kaella xmlns:java= "java:se.sbab.isk.api.intern.modell" > SPAR </java:Kaella> <java:Kontaktbar xmlns:java= "java:se.sbab.isk.api.intern.modell" > true </java:Kontaktbar> <java:PersonnummerTypText xmlns:java= "java:se.sbab.isk.api.intern.modell" > Personnummer </java:PersonnummerTypText> <java:KonText xmlns:java= "java:se.sbab.isk.api.intern.modell" > Man </java:KonText> <java:KundvaltEfternamn xmlns:java= "java:se.sbab.isk.api.intern.modell" > Anton </java:KundvaltEfternamn> <java:KundvaltFornamn xmlns:java= "java:se.sbab.isk.api.intern.modell" > Arvidsson </java:KundvaltFornamn> <java:Personnummer xmlns:java= "java:se.sbab.isk.api.intern.modell" > 197811153134 </java:Personnummer> <java:Skyddad xmlns:java= "java:se.sbab.isk.api.intern.modell" > false </java:Skyddad> <java:SBABAnstalld xmlns:java= "java:se.sbab.isk.api.intern.modell" > false </java:SBABAnstalld> <java:KorrektAvlidenDatum xmlns:java= "java:se.sbab.isk.api.intern.modell" > false </java:KorrektAvlidenDatum> <java:Kon xmlns:java= "java:se.sbab.isk.api.intern.modell" > 0 </java:Kon> <java:Personnummertyp xmlns:java= "java:se.sbab.isk.api.intern.modell" > 0 </java:Personnummertyp> <java:Fodelsedag xmlns:java= "java:se.sbab.isk.api.intern.modell" > 19781115 </java:Fodelsedag> <java:AvlidenDatum xsi:nil= "true" xmlns:java= "java:se.sbab.isk.api.intern.modell" /> <java:KundvaltMellannamn xsi:nil= "true" xmlns:java= "java:se.sbab.isk.api.intern.modell" /> <java:Postadresser xmlns:java= "java:se.sbab.isk.api.intern.modell" > <java:Adressrad1> BOX 27308 </java:Adressrad1> <java:Adressrad2 xsi:nil= "true" /> <java:Adressrad3 xsi:nil= "true" /> <java:Land> SVERIGE </java:Land> <java:Postnr> 10254 </java:Postnr> <java:Postort> STOCKHOLM </java:Postort> <java:Primar> true </java:Primar> <java:Typ> 1 </java:Typ> </java:Postadresser> </m:return> </m:hamtaFysiskPersonResponse> </env:Body> </env:Envelope> Note The webservice_username and webservice_password fetched above will expire in 30 minutes unless accessed.
Every operation where the username and password needs to be verified will refresh this period, up to a maximum time
of 3 hours. More information regarding login flows, for instance PSD2, can be found in the partner-auth-service README.md file Authorization ï All the calls issued above assumed that the authenticated user had access to the requested resource, i.e. was authorized
to performed the requested operation. JWT ï The access token sent in the HTTP request will need to be translated to a JWT before it can be used by the target service.
This is usually done in the Spring framework using the jwt-auth-spring library. This library also contains detailed information on how to configure and use roles and skills to control access
to requested resources. The JWT can also be fetched manually using an HTTP request to the partner-auth-service or copied using the Quick Auth app Copy JWT button (SBAB test customers only): curl - X GET -- location "https://k8sproxy.sys.sbab.se/partner-auth-service/v1/auth/usertoken?access_token=6f61b2fc-1e30-4c02-b312-a3b1821914f9" \ - H "accept: application/json ;charset=utf-8" JSON response: { "token" : "eyJraWQiOiJrMiIsImFsZyI6IlJTNTEyIn0.eyJpc3MiOiJTQkFCIiwiZXhwIjoxNjU5OTkzMjE2LCJqdGkiOiJ0RUdxZVpoeExBdDgya0twVlI2cHh3IiwiaWF0IjoxNjU5OTY0NDE2LCJuYmYiOjE2NTk5NjQyOTYsInN1YiI6Im1pY3Jvc2VydmljZSIsInNjb3BlIjpbIkNMSUVOVCIsIlBBU19BRE1JTiJdLCJjbGllbnQiOiJtaWNyb3NlcnZpY2UiLCJza2lsbHMiOltdfQ.P7m4YwKGiV5K6Ib4xa7dgpNgi04GwKIjMOeA8qk01i-yGqU0fqw_CxKQWt-fRXwur1jpks9IfeyFPx6ijoI2Hr5dnFYxiW0nnhb5bYwsuz-RgPmBFVbPp1b8bLr7kfmb2iqVHiapvUdGdoD7LAdZJXVZNuXj0fgN2HN-PPxtRu4inzEtF4eHMmouYjBSVG1-Zb32_xSyWYL_mrD_wMpFgCktcBE4Ks-yFr6OjH8IAr9pccefraNKuDNweu98k3hqmPgw0kQYsYjDqmnsNM-rxndJwcyRN1Qe_ZddruCG78AjHH-1IB_Aq6_kJsm5iSDCL1RejRxBIyIDhz1HDPuHhA" } The JWT token in the response consists ot three Base64 encoded parts, separated by dots. Use the online jwt debugger at jwt.io to view the content: eDirectory ï The microservice service user is authenticated in eDirectory by the partner-auth-service at cn=microservice,ou=systemanv,o=Sbab . The microservice list of scopes CLIENT and PAS_ADMIN in this case, are available under ou=ServiceRoles,o=Sbab Tip Use Apache Directory Studio to browse eDirectory in sys: Connection name edir-sys Hostname t-edir01-l.sbab.se Port 389 Bind DN or user cn=guest,o=sbab Bind password bytkod Count Limit 1000 The call to fetch effective-interest-rate used the microservice service user. This call was authorized in prior-information-service CustomerCostResourceV1 resource by using the annotation @RolesAllowed("CLIENT") . Since CLIENT was one of the scopes listed in the JWT,
the request was authorized. SBAB employees will use SBAB ActiveDirectory (LDAP) for authentication and eDirectory for authorization info (scope and skills).
The AD root node is internal users , for example CN=Peter Knuts,OU=internal users,OU=sbab users,DC=sbab,DC=ad The corresponding root node in eDirectory used to fetch authorization info is cn=pknu,ou=USERS,ou=AS-STO,ou=SE,ou=SBAB-ORG,o=Sbab . This information will be used to populate the corresponding JWT with scope and skills: An eDir SVIPRole will become a JWT scope and an eDir SVIPSkill will become a JWT skill . Tip A description of how to add new skills to eDir can be found on Confluence Legacy ï The IS legacy system uses a custom WebLogic realm to perform authorization. The information used is stored in eDirectory
under one of two mirrored roots, that should be identical: dc=WLSServerSecure_1,o=Sbab dc=WLSServerSecure_2,o=Sbab For WebService calls, the root is cn=WebService,dc=WLSServerSecure_1,o=Sbab The authorization process used to access the SECURITY_KundinfoService as the service user sys_securityws in the Legacy WebServices example above, is preformed in the following steps by the WebLogic realm: Find the correct java module and WebService method th the eDirectory structure below the WebService node: cn=hamtaKundbehorighet,cn=ISK_WS_SECURITY_KundinfoSoapPort,cn=/ISK_WS,cn=ISK_EAR If this node exist, check that the user is referenced by a WLSPrincipals attribute. cn=sys_securityws,ou=systemanv,ou=InternetBank,o=Sbab If the correct principal exist on the node/method, the request will be granted. If the node hamtaKundbehorighet does NOT exist, the authorization will delegate to the parent node and do the
same check there in a recursive way. A special attribute WLSEveryone can be set to true of false to allow or
disallow the request and thereby stop the recursion at any level. In case the WebService is accessed as an SBAB customer, as in the second example in Legacy WebServices above
the following node in eDirectory will be searched: cn=hamtaFysiskPerson,cn=ISK_WS_PartinfoSoapPort,cn=/ISK_WS,cn=ISK_EAR The WLSPrincipals in this case contains a reference to the customer root at ou=Kunder,ou=Privatspar,ou=InternetBank,o=Sbab This means that the request will be authorized for an SBAB customer that exist with an CN equal to the NIN of the customer.
In the example above, the customer exist at cn=197811153134,ou=Kunder,ou=Privatspar,ou=InternetBank,o=Sbab The same principal is used for REST based web-services below the EJB node cn=EJB,dc=WLSServerSecure_1,o=Sbab and
web applications below the URL node cn=URL,dc=WLSServerSecure_1,o=Sbab Intellij ï Intellij IDEA IDE have a nice feature to run various HTTP requests with the click of a button. This can be used to
fetch access tokens needed to use for instance in Swagger authentication to test an API. To create an access token for the microservice/bytkod user, the following partner-auth-service.http file can be used: # Authentication header for user microservice/bytkod in sys

POST https://k8sproxy.sys.sbab.se/partner-auth-service/v1/auth/token
Authorization: Basic microservice bytkod
accept: application/json
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials

> {%
    client.global.set("access_token", response.body["access_token"])
%}

###

# Fetch usertoken from a given UUID access token. The script above must be executed before the access_token below is set
GET https://k8sproxy.sys.sbab.se/partner-auth-service/v1/auth/usertoken?access_token={{access_token}}
accept: application/json ;charset=utf-8

### Clicking the Run HTTP Request arrow next to the post request will then respond with an access token for the
microservice service user. The next request in the file is used to fetch the JWT for the access token: Note Authorization in the http file above can either be set in clear text with a space separator between the username
and password or as a Base64 encoded value of microservice:bytkod = bWljcm9zZXJ2aWNlOmJ5dGtvZA== ActiveDirectory ï Tip Use Apache Directory Studio to browse the SBAB AD: Connection name SBAB LDAP Hostname sbabdc.sbab.ad Port 389 Bind DN or user <your AD user> (example: pknu @ sbab . ad ) Bind password <your AD password> Base DN DC=sbab,DC=ad Count Limit 1000 Previous Next © Copyright 2024, TNT. Built with Sphinx using a theme provided by Read the Docs .