Argo Workflows — SBAB Docs  documentation SBAB Docs Ansible Controller Ansible Roles Ansible Vault Argo Workflows Way of Working Access to the Argo UI URLâs Workflows Retry/Resubmit Logs Apply changes from argo-vault Adding new workflows Templates Alerts Slack Email SMS Upgrades Migration Authentication & Authorization Bitbucket Boost Chatbot Booli Ceph Dex Fortigate troubleshooting Generate certificate Go GitHub Copilot GitLab @Sbab User Guide GitLab Maintenance Grafana Istio Java Jenkins Jenkinsfile Jmeter Kafka Maintenance Kafka @Sbab User Guide Kafka Connect Kubectl Access Kubernetes Lab environment Local Open Web Metrics infrastructure MongoDB Netbox NVIDIA Neo4J Sonatype Nexus repository Oracle OWASP Database OWASP @Sbab User Guide Pact Principles of Security Prometheus ReactJS Redis Renovate S3 Security Guidelines for Developers Sentry Maintenance Sentry User Guide Configuring Variables for Services Deployed to Kubernetes Software Architecture SonarQube Maintenance SonarQube User Guide Structurizr System Landscape Vagrant Zipkin Windows Pipelines SBAB Docs » Argo Workflows View page source Argo Workflows ï Documentation: https://argo-workflows.readthedocs.io/en/latest/ GitHub: https://github.com/argoproj/argo Local setup: https://stash.sbab.se/projects/TNT/repos/argo-poc Way of Working ï Access to the Argo UI ï All logged in users are granted read access to Argo by default. If you require write access, for instance, to manually submit workflows, you can apply for the necessary resources through the IAM portal . The following resources are available: Access to Argo test environment (valid for both sys/acc/stage) Access to Argo production environment URLâs ï Sys: https://argo.sys.sbab.se/ Acc: https://argo.acc.sbab.se/ Stage: https://argo.stage.sbab.se/ Prod: https://argo.prod.sbab.se/ Workflows ï Navigate to https://argo.{env}.sbab.se/workflows/ to see the list of executed workflows.
It is possible to filter on labels in the left menu, e.g. workflows=sap . Retry/Resubmit ï It is possible to retry a failed workflow from the step it failed.
If the workflow has failed, the button RETRY will be visible on the failed workflow. It is also possible to resubmit workflows, both successful and failed workflows. A resubmit till trigger the workflow from the very beginning.
There are two ways of resubmitting: Locate the workflow in https://argo.{env}.sbab.se/workflows/ and click the RESUBMIT button. Or locate the workflow in the cron list https://argo.{env}.sbab.se/cron-workflows/ and click the SUBMIT button. Logs ï Logs can be found in Splunk, e.g. argo=âargo-init.prodâ sapks3801 .
Logs can also be found on the workflow itself. Available  logs: argo="argo-init.{env}" argo="argo-main.{env}" argo="argo-wait.{env}" Apply changes from argo-vault ï Any changes made to the argo-vault.yml file in ansible repo needs to be applied.
Start the workflow pipeline Adding new workflows ï Add the new workflow in templates/workflows Wait for the pipeline to deploy Templates ï The two templates directories are used for: Directory Purpose workflows Individual workflows consisting of >= 1 tasks workflow_templates Individual templates used by one (or similar) workflows We only support workflows of kind kind: CronWorkflow since we are automatically cleaning up old workflows (of type kind: Workflow ). CronWorkflow can be triggered by cron if schedule is specified CronWorkflow can be triggered with cURL CronWorkflow can be triggered manually: Found at: https://argo.sys.sbab.se/cron-workflows/argo A new entry in https://argo.sys.sbab.se/workflows/ will appear when cron triggers it Alerts ï Alerts can be sent via either Slack, Email or SMS. If you only specify the exit-handler without the condition, the alert will be sent for both successful and failed workflows.ï£¿ Slack ï In this example, saptest01 is configured to alert #alerts-sap-test for failures in sys/acc/stage
and #alerts-sap-prod for production failures. Create two new channels, #alerts-<custom name>-test and #alerts-<custom name>-prod Contact #team-tnt and ask to get webhooks for your 2 new channels: https://api.slack.com/apps/A01FPRFH84Q/incoming-webhooks Create Ansible variables similar to argo_alerts_sap_webhook_url in: inventories/ossys/group_vars/k8s/argo.yml inventories/osacc/group_vars/k8s/argo.yml inventories/osstage/group_vars/k8s/argo.yml inventories/osprod/group_vars/k8s/argo.yml Update slackChannels in workflows/k8s/values.yaml , similar to alerts_sap Configure onExit: exit-handler to the desired workflow, e.g: apiVersion : argoproj . io / v1alpha1 ... spec : ... workflowSpec : ... onExit : exit - handler templates : ... - name : exit - handler dag : tasks : - name : send - slack - notification templateRef : name : notification template : slack clusterScope : true arguments : parameters : - name : webhook value : {{ . Values . slackChannels . alerts_sap }} when : "{{`{{workflow.status}}`}} != Succeeded" Email ï Email alerts are sent to the email address specified in the workflow. The example below is configured to send alerts whenever a workflow fails. Configure onExit: exit-handler to the desired workflow, e.g: apiVersion : argoproj . io / v1alpha1 ... spec : ... workflowSpec : ... onExit : exit - handler templates : ... - name : exit - handler dag : tasks : - name : send - email - notification templateRef : name : notification template : email clusterScope : true arguments : parameters : - name : address value : {{ . Values . emailAddresses . alerts_sap }} when : "{{`{{workflow.status}}`}} != Succeeded" SMS ï SMS alerts are sent to the phone number specified in the workflow. The example below is configured to send alerts whenever a workflow fails. Configure onExit: exit-handler to the desired workflow, e.g: apiVersion : argoproj . io / v1alpha1 ... spec : ... workflowSpec : ... onExit : exit - handler templates : ... - name : exit - handler dag : tasks : - name : send - sms - notification templateRef : name : notification template : sms clusterScope : true arguments : parameters : - name : number value : {{ . Values . phoneNumbers . alerts_sap }} when : "{{`{{workflow.status}}`}} != Succeeded" Upgrades ï Locate the latest available tag in argoproj/argo Update se.sbab/argo to use the latest available tag Update argoVersion to the latest available tag Update dockerImage to the latest available tag Uninstall earlier argo installation by running helm uninstall on all helm charts in the argo namespace. Wait for the pipeline to deploy Migration ï Follow these steps to migrate from one to another data center. Locate the best time to migrate Argo when there are no workflows running, e.g. Last 7 days : source = init . prod argo NOT "Loading script source" NOT python - batch - test NOT TESTBATCH01 NOT SAPTEST01 NOT hello - world Announce about Argo migration and planned short downtime in the test or prod channel below: #planned-production-disruption #testenvironments Scale down Argo in the old data center: kubectl -- namespace argo scale deployment -- all -- replicas = 0 Change only_datacenter in the repos below. Do it in this order and wait for each deploy to success before deploying the next repository: argo-workflows/.gitlab-ci.yml argo-cluster-workflow-templates/.gitlab-ci.yml workflows/.gitlab-ci.yml Wait for the pipelines to deploy Verify that Argo in the new data center works, e.g trigger https://argo.{env}.sbab.se/cron-workflows/argo/testbatch01 Clean up Argo from the old data center: helm uninstall argo - workflows -- namespace argo helm uninstall workflows -- namespace argo ( its okay if the uninstallation fails ) helm uninstall argo - cluster - workflow - templates -- namespace argo ( its okay if the uninstallation fails ) helm list -- namespace argo ( Doublecheck that all the helm charts are uninstalled ) kubectl delete namespace argo Fetch the new teis JWT from the teis service account: SECRET=$(kubectl -n argo get serviceaccount teis -o=jsonpath='{.secrets[0].name}')
TOKEN="$(kubectl -n argo get secret ${SECRET} -o=jsonpath='{.data.token}' | base64 --decode)" Send the new JWT to iops to update the scripts on the teis server Previous Next © Copyright 2024, TNT. Built with Sphinx using a theme provided by Read the Docs .