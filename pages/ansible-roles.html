Ansible Roles — SBAB Docs  documentation SBAB Docs Ansible Controller Ansible Roles Pre-requisites Initialize a new role Testing locally Mocked modules Avoid build collisions Extracting roles from main repo Ansible Vault Argo Workflows Authentication & Authorization Bitbucket Boost Chatbot Booli Ceph Dex Fortigate troubleshooting Generate certificate Go GitHub Copilot GitLab @Sbab User Guide GitLab Maintenance Grafana Istio Java Jenkins Jenkinsfile Jmeter Kafka Maintenance Kafka @Sbab User Guide Kafka Connect Kubectl Access Kubernetes Lab environment Local Open Web Metrics infrastructure MongoDB Netbox NVIDIA Neo4J Sonatype Nexus repository Oracle OWASP Database OWASP @Sbab User Guide Pact Principles of Security Prometheus ReactJS Redis Renovate S3 Security Guidelines for Developers Sentry Maintenance Sentry User Guide Configuring Variables for Services Deployed to Kubernetes Software Architecture SonarQube Maintenance SonarQube User Guide Structurizr System Landscape Vagrant Zipkin Windows Pipelines SBAB Docs » Ansible Roles View page source Ansible Roles ï Roles in Ansible are to create and testable when using Molecule . Pre-requisites ï Install molecule : pip install --upgrade molecule Install docker : pip install --upgrade docker Initialize a new role ï Note Make sure to either set the environment variable ${ROLE_NAME} with the name of the role
or replace this from our examples, if you are copying and pasting. Initialize role: molecule init role --role-name ${ ROLE_NAME } --driver-name docker cd ${ ROLE_NAME } Remove unnecessary generated files: rm -rf README.md defaults/ handlers/ vars/ Add a .gitignore , e.g: .idea
molecule/default/tests/__pycache__/
roles Add a Jenkinsfile with the Ansible Roles pipeline Update meta/main.yml by removing commented code and including dependencies (if necessary), e.g: --- galaxy_info : author : Team TNT <tnt@sbab.se> company : SBAB Bank AB license : Proprietary to SBAB Bank AB description : ${ROLE_NAME} min_ansible_version : 2.7 platforms : - name : CentOS dependencies : # This dependency will be automatically installed when installing # your role with ansible-galaxy - name : global-variables src : https://stash.sbab.se/scm/ans/global-variables.git scm : git version : master If necessary, add role dependencies to molecule/default/requirements.yml , e.g: --- - name : global-variables src : https://stash.sbab.se/scm/ans/global-variables.git scm : git version : master If necessary, use our sbab-centos-base Docker image in molecule/default/molecule.yml , e.g: platforms : - name : ${ROLE_NAME}-${BUILD_NUMBER:-1} image : se.sbab/sbab-centos-molecule:latest registry : url : nexus.common.sbab.se:18443 Testing locally ï To run all test scenarios: molecule test To create a local environment and execute the role inside it: molecule converge To login into the local environment after creating it with molecule converge : molecule login To destroy the local environment: molecule destroy Mocked modules ï If the role will control one or more services using systemd, you will need to use a mocked
version of the systemd ansible module for testing with molecule in a docker container. We have a created the mocked-test-libs repository, which includes the systemd
mocked module. To use this, update molecule/default/playbook.yml with: roles : - role : mocked-test-libs And molecule/default/requirements.yml with: - name : mocked-test-libs src : https://stash.sbab.se/scm/ans/mocked-test-libs.git scm : git version : master So what does the mocked systemd module do? Instead of actually using the real systemd, which needs capabilities and special mounts on the docker container,
this module will just keep a state of what should (in a best case scenario) be the state of a SystemD unit.
The state is tracked by a file in the /etc/ directory. Avoid build collisions ï Molecule generates the molecule.yml file with the default instance name instance . This is very risky, as it will
most probably collide with other builds in jenkins as this is the name set for the docker container. Therefore you will need to set this to a unique name for your role, and also add the jenkins build-number at the end.
Like weâve done in the Kafka role : # molecule/default/molecule.yml (partial) platforms : - name : kafka-${BUILD_NUMBER:-1} As you see on in the example, at the end, the platform name has a suffix with an environment variable named BUILD_NUMBER . Locally this will default to 1, but in Jenkins this will be the actual build number.
This way we avoid collisions between molecule test builds in Jenkins. Extracting roles from main repo ï Roles can be extracted from the ansible repository one by one
overtime when role updates are required. Itâs not recommended to work on the roles directory in the main repository, rather use
the extract workflow to make Ansible more modular. Initialize a new role . Push the changes to a new repository in the Ansible project . Remove the files from the ansible repository . Commit and push the changes. Previous Next © Copyright 2024, TNT. Built with Sphinx using a theme provided by Read the Docs .