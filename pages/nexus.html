Sonatype Nexus repository — SBAB Docs  documentation SBAB Docs Ansible Controller Ansible Roles Ansible Vault Argo Workflows Authentication & Authorization Bitbucket Boost Chatbot Booli Ceph Dex Fortigate troubleshooting Generate certificate Go GitHub Copilot GitLab @Sbab User Guide GitLab Maintenance Grafana Istio Java Jenkins Jenkinsfile Jmeter Kafka Maintenance Kafka @Sbab User Guide Kafka Connect Kubectl Access Kubernetes Lab environment Local Open Web Metrics infrastructure MongoDB Netbox NVIDIA Neo4J Sonatype Nexus repository Nexus repository Setup DNS Data synchronization Migration Upgrade Certificate renewal Oracle OWASP Database OWASP @Sbab User Guide Pact Principles of Security Prometheus ReactJS Redis Renovate S3 Security Guidelines for Developers Sentry Maintenance Sentry User Guide Configuring Variables for Services Deployed to Kubernetes Software Architecture SonarQube Maintenance SonarQube User Guide Structurizr System Landscape Vagrant Zipkin Windows Pipelines SBAB Docs » Sonatype Nexus repository View page source Sonatype Nexus repository ï Tip For more information, see here Note Tasks with the prefix âRepairâ should only be run manually, not scheduled.
For more information, see https://help.sonatype.com/repomanager3/system-configuration/tasks#Tasks-TypesofTasksandWhentoUseThem Nexus repository ï Nexus is our internal artifact repository. Setup ï We have two instances of Nexus, one active and one passive. All data from active instance will be synchronized to passive
one four times per day. See OpenStack common inventory. DNS ï Data synchronization ï Cron job has been used to synchronize data from active instance to passive instance. Add below scripts as root to crontab if active host=nexus: 2 0 * * * rsync - avP -- chown = nexus : nexus -- del - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / nexus @ 10.47.60.50 : / opt / sonatype / sonatype - work / 41 5 * * * systemctl stop nexus ; sleep 1 m ; rsync - avP -- chown = nexus : nexus -- del - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / nexus @ 10.47.60.50 : / opt / sonatype / sonatype - work / ; systemctl start nexus ; 2 12 * * * rsync - avP -- chown = nexus : nexus - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / nexus @ 10.47.60.50 : / opt / sonatype / sonatype - work / 2 18 * * * rsync - avP -- chown = nexus : nexus - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / nexus @ 10.47.60.501 : / opt / sonatype / sonatype - work / Add below scripts as root to crontab if active host=c-nexus01-l.sbab.ad: 2 0 * * * rsync - avP -- chown = nexus : nexus -- del - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / nexus @ 10.43.253.10 : / opt / sonatype / sonatype - work / 41 5 * * * systemctl stop nexus ; sleep 1 m ; rsync - avP -- chown = nexus : nexus -- del - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / nexus @ 10.43.253.10 : / opt / sonatype / sonatype - work / ; systemctl start nexus ; 2 12 * * * rsync - avP -- chown = nexus : nexus - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / nexus @ 10.43.253.10 : / opt / sonatype / sonatype - work / 2 18 * * * rsync - avP -- chown = nexus : nexus - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / nexus @ 10.43.253.10 : / opt / sonatype / sonatype - work / After enabling rsync on the new active host, make sure to verify after the next rsync that it works. E.g by checking /opt/sonatype/nexus.log . Migration ï Follow these steps to migrate Nexus from one data center to another. In this case, from NSX to KI. Scenario: active host : c - nexus01 - l . sbab . ad ( https : // c - nexus01 - l . sbab . ad : 8443 / ) passive host : nexus ( https : // nexus11 . common . sbab . se : 8443 / ) Check logs for batch scheduler to find out when there are no batch jobs running Navigate to Manage Jenkins and click the Prepare for Shutdown button Run below script from current active host, in this case c-nexus01-l.sbab.ad : sudo systemctl stop nexus sleep 3 m sudo rsync - avP -- chown = nexus : nexus -- del - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / nexus @ 10.43.253.10 : / opt / sonatype / sonatype - work / Run below script from current passive host, in this case nexus : sudo chown - R nexus : nexus / opt / sonatype / sonatype - work / sudo systemctl enable nexus sudo systemctl start nexus Check in logs to see that Nexus has started without exceptions/errors: sudo tail - f / opt / sonatype / sonatype - work / nexus3 / log / nexus . log Browse Nexus, in this case: https://nexus11.common.sbab.se:8443/ Point nexus.common.sbab.se to nexus11.common.sbab.se Wait until the DNS change takes effect Navigate to Manage Jenkins and click the Cancel Shutdown button Test multiple Jenkins builds: https://jenkins.common.sbab.se:8443/job/TNT/job/spring-template/job/dev/ https://jenkins.common.sbab.se:8443/job/TNT/job/go-template/job/dev/ https://jenkins.common.sbab.se:8443/job/TNT/job/java-lib-test/job/dev/ https://jenkins.common.sbab.se:8443/job/TNT/job/react-app-template-3/job/dev/ https://jenkins.common.sbab.se:8443/job/TNT/job/node-app-template/job/dev/ https://jenkins.common.sbab.se:8443/job/LGC/job/webben/job/dev/ Disable cron, service and permissions on c-nexus01-l.sbab.ad : sudo crontab - e sudo crontab - l # verify that there are no entries sudo systemctl disable nexus sudo rm / opt / sonatype / nexus . log Enable cron on nexus , see which lines to copy from Data synchronization : sudo crontab - e Remove volume snapshot: OS_CLOUD = common2 volume delete nexus_sonatype_vol Upgrade ï nexus-lab in oscommon inventory can be used for testing of deploy-nexus playbook. Scenario: active host : nexus passive host : c - nexus01 - l . sbab . ad Use this splunk search to find out when it is OK to do the upgrade, i.e. when there are no batch jobs running. Jenkins -> Manage Jenkins -> âPrepare for Shutdownâ Run below script from active host in this case nexus : systemctl stop nexus ; sleep 3 m ; rsync - avP -- del - e 'ssh -p 22' -- progress -- log - file = "/opt/sonatype/nexus.log" / opt / sonatype / sonatype - work / ansible @nexus21 : / opt / sonatype / sonatype - work / ; systemctl start nexus ; Important data will be corrupted if nexus service is not stopped before synchronization Jenkins -> Manage Jenkins -> âCancel Shutdownâ On c-nexus01-l.sbab.ad host, run âchown -R nexus:nexus /opt/sonatype/sonatype-work/â Run deploy nexus playbook: ansible - playbook - i inventories / common playbooks / deploy - nexus . yml -- skip - tags "new_server" - e nexus_version = 3.25.0 - 03 -- limit c - nexus01 - l . sbab . ad After successful deploy check if nexus on the host is up and running, e.g. https://c-nexus01-l.sbab.ad:8443/ Jenkins -> Manage Jenkins -> âPrepare for Shutdownâ Change CNAME in DNS to the upgraded host and wait until DNS change takes effect Jenkins -> Manage Jenkins -> âCancel Shutdownâ Run several Jenkins build to test that builds, pulling and pushing docker images, etc are working as expected. Disable all cron jobs and nexus.service on host nexus (formerly known as active host) On nexus host, run chown -R ansible:ansible /opt/sonatype/sonatype-work/ Create cron job on c-nexus01-l.sbab.ad , see which lines to copy from Data synchronization Run deploy nexus playbook: ansible - playbook - i inventories / oscommon playbooks / deploy - nexus . yml -- skip - tags "new_server,install_service" - e nexus_version = 3.25.0 - 03 -- limit nexus Certificate renewal ï Run the Makefile-Nexus in Docker, see the repository README.md Update nexus.server.keystore.jks.orig with the newly generated file Run deploy playbook with these tags on the passive host, e.g: ansible - playbook - i inventories / oscommon playbooks / deploy - nexus . yml -- skip - tags always -- tags certs_renewal -- limit nexus Run deploy playbook with these tags on the active host, e.g: ansible - playbook - i inventories / common playbooks / deploy - nexus . yml -- skip - tags always -- tags certs_renewal -- limit c - nexus01 - l . sbab . ad Previous Next © Copyright 2024, TNT. Built with Sphinx using a theme provided by Read the Docs .